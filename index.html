<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Kaleidoscope</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>

<body>

    <div id="controls">
        <div class="control-header">

            <div class="mode-switch">
                <button id="btn-eraser" class="submode-btn" onclick="toggleEraser()"
                    style="background:rgba(0,0,0,0.4); border:1px solid cyan; color:cyan; border-radius:12px; padding:4px 8px; font-size: 0.7em; font-weight:bold; margin-right: 8px;">
                    æ¶ˆã—ã‚´ãƒ </button>
                <!-- <button id="btn-physics" class="mode-btn active" onclick="setMode('physics')">ç‰©ç†</button> -->
                <!-- <button id="btn-audio" class="mode-btn" onclick="setMode('audio')">Audio</button>
                <button id="btn-fractal" class="mode-btn" onclick="setMode('fractal')">Frac</button> -->
            </div>
            <!-- Debug button moved to settings -->
            <!-- ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã¯ä¸€æ™‚çš„ã«éè¡¨ç¤º -->
            <!-- <button id="startAudio" class="icon-btn" onclick="toggleAudio()" title="Toggle Mic">ğŸ¤</button> -->
            <button id="btn-install" class="icon-btn" onclick="installPWA()" title="ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ "
                style="display:none;">â¬‡ï¸</button>
            <button id="toggleSettings" class="icon-btn" onclick="document.body.classList.toggle('settings-open')"
                title="è¨­å®š">âš™ï¸</button>
        </div>

        <!-- Physics Sub-Modes (Visible in Physics Mode) -->
        <div id="physics-modes"
            style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; padding: 5px; margin-bottom: 5px;">
            <button id="btn-mode-gravity" class="submode-btn active" onclick="setPhysicsSubmode('gravity')"
                style="flex:1; background:rgba(0,0,0,0.4); border:1px solid #555; color:white; border-radius:15px; padding:5px;">è‡ªå‹•</button>
            <button id="btn-mode-float" class="submode-btn" onclick="setPhysicsSubmode('float')"
                style="flex:1; background:rgba(0,0,0,0.4); border:1px solid #555; color:white; border-radius:15px; padding:5px;">ç„¡é‡åŠ›</button>
            <button id="btn-mode-gyro" class="submode-btn" onclick="setPhysicsSubmode('gyro')"
                style="flex:1; background:rgba(0,0,0,0.4); border:1px solid #555; color:white; border-radius:15px; padding:5px;">ã‚¸ãƒ£ã‚¤ãƒ­</button>
            <!-- Eraser button moved to header -->
        </div>
        <script>
            // Simple Active State Toggle Helper
            const subBtns = document.querySelectorAll('.submode-btn');
            subBtns.forEach(btn => {
                if (btn.id !== 'btn-eraser') {
                    btn.addEventListener('click', () => {
                        subBtns.forEach(b => { if (b.id !== 'btn-eraser') b.style.background = 'rgba(0,0,0,0.4)'; });
                        btn.style.background = 'rgba(0,255,255,0.3)';
                    });
                }
            });
            // Init active
            setTimeout(() => {
                const gBtn = document.getElementById('btn-mode-gravity');
                if (gBtn) gBtn.style.background = 'rgba(0,255,255,0.3)';
            }, 100);
        </script>

        <div class="settings-panel">
            <!-- Global Settings -->
            <div class="control-row" style="margin-bottom: 10px; justify-content: flex-end;">
                <button id="toggleDebug" class="icon-btn" onclick="toggleDebug()" title="ãƒ‡ãƒãƒƒã‚°æƒ…å ±"
                    style="font-size: 1.2em;">ğŸ</button>
            </div>
            <div class="control-row">
                <label class="checkbox-label">
                    <span>è‡ªå‹•å›è»¢</span>
                    <input type="checkbox" id="autoRotateControl" checked>
                </label>
            </div>

            <!-- Physics Mode Settings -->
            <div id="physics-settings">
                <div class="slider-group">
                    <label>é‡åŠ› <span id="val-gravity">1.0</span></label>
                    <input type="range" id="gravityControl" min="0" max="2" step="0.1" value="1">
                </div>
                <div class="slider-group">
                    <label>ã‚µã‚¤ã‚º <span id="val-scale">1.0</span></label>
                    <input type="range" id="scaleControl" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
                <div class="slider-group">
                    <label>ç©ºæ°—æŠµæŠ— <span id="val-friction">0.05</span></label>
                    <input type="range" id="frictionControl" min="0" max="0.5" step="0.01" value="0.05">
                </div>
                <div class="slider-group">
                    <label>å£ãƒã‚¦ãƒ³ãƒ‰ <span id="val-restitution">0.6</span></label>
                    <input type="range" id="restitutionControl" min="0" max="1.2" step="0.1" value="0.6">
                </div>
                <div class="slider-group">
                    <label>å®çŸ³ãƒã‚¦ãƒ³ãƒ‰ <span id="val-gem-restitution">0.6</span></label>
                    <input type="range" id="gemRestitutionControl" min="0" max="1.2" step="0.1" value="0.6">
                </div>
                <div class="slider-group">
                    <label>å›è»¢é€Ÿåº¦ <span id="val-rotate-speed">1.0</span></label>
                    <input type="range" id="rotateSpeedControl" min="0" max="5.0" step="0.1" value="1.0">
                </div>
                <div class="slider-group">
                    <label>å€‹æ•° <span id="val-count-setting">32</span></label>
                    <input type="range" id="countControl" min="0" max="500" step="1" value="32">
                </div>
            </div>

            <!-- Fractal Mode Settings -->
            <div id="fractal-settings" style="display: none;">
                <div class="slider-group">
                    <label>ã‚ºãƒ¼ãƒ é€Ÿåº¦ <span id="val-zoom-speed">1.02</span></label>
                    <input type="range" id="zoomSpeedControl" min="1.001" max="1.1" step="0.001" value="1.02">
                </div>
                <div class="slider-group">
                    <label>ç”»è³ª <span id="val-quality">0.25</span></label>
                    <input type="range" id="qualityControl" min="0.1" max="1.0" step="0.05" value="0.25">
                </div>
                <div class="slider-group">
                    <label>ç¨®é¡</label>
                    <select id="fractalTypeControl"
                        style="width: 100%; padding: 5px; background: rgba(0,0,0,0.5); color: white; border: 1px solid cyan;">
                        <option value="mandelbrot">ãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­</option>
                        <option value="julia">ã‚¸ãƒ¥ãƒªã‚¢é›†åˆ</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div id="debug-dashboard">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
            <div id="debug-text">
                <div>Alpha: <span id="val-alpha">--</span></div>
                <div>Beta : <span id="val-beta">--</span></div>
                <div>Gamma: <span id="val-gamma">--</span></div>
                <div>GravX: <span id="val-grav-x">--</span></div>
                <div>GravY: <span id="val-grav-y">--</span></div>
                <div>Count: <span id="val-count">--</span></div>
                <div>Energy: <span id="val-energy">--</span></div>
                <div>FPS: <span id="val-fps">--</span></div>
                <div>Mouse: <span id="val-mouse">--</span></div>
                <div>Res : <span id="val-res">--</span></div>
            </div>
            <canvas id="debug-arrow" width="60" height="60"
                style="background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);"></canvas>
        </div>
        <canvas id="debug-graph" width="280" height="60"
            style="width: 100%; margin-top: 2px; background: rgba(0,0,0,0.3);"></canvas>
        <canvas id="debug-graph-sensor" width="280" height="60"
            style="width: 100%; margin-top: 2px; background: rgba(0,0,0,0.3);"></canvas>
    </div>
    <canvas id="kaleidoscope-canvas"></canvas>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(e => console.warn('SW error:', e));
        }

        // DEBUG: Tap to identify element under touch (activate with debug mode)
        window._debugTap = false;
        document.addEventListener('touchstart', (e) => {
            if (!window._debugTap) return;
            const t = e.touches[0];
            const x = t.clientX, y = t.clientY;
            const els = document.elementsFromPoint(x, y);
            const elDesc = els.map(el => `${el.tagName}#${el.id}.${[...el.classList].join('.')}`).join(' > ');
            // Also grab canvas pixel
            const cvs = document.getElementById('kaleidoscope-canvas');
            let px = '?';
            if (cvs) {
                const ctx = cvs.getContext('2d');
                const d = ctx.getImageData(x, y, 1, 1).data;
                px = `rgba(${d[0]},${d[1]},${d[2]},${d[3]})`;
            }
            const dbg = document.getElementById('debug-text');
            if (dbg) dbg.innerHTML = `TAP:(${Math.round(x)},${Math.round(y)})<br>PIX:${px}<br>${elDesc}`;
            const dbgDiv = document.getElementById('debug-dashboard');
            if (dbgDiv) dbgDiv.classList.add('visible');
        }, { passive: true });
        // toggleDebug will also enable tap debug
        const _origToggle = window.toggleDebug;
        window.addEventListener('load', () => {
            const origFn = window.toggleDebug;
            window.toggleDebug = function () {
                origFn && origFn();
                window._debugTap = !window._debugTap;
            };
        });

        // PWA Install Prompt
        let deferredInstallPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            const btn = document.getElementById('btn-install');
            if (btn) btn.style.display = 'flex';
        });

        window.installPWA = function () {
            if (!deferredInstallPrompt) return;
            deferredInstallPrompt.prompt();
            deferredInstallPrompt.userChoice.then((choice) => {
                deferredInstallPrompt = null;
                // Only hide button if user accepted. If dismissed, keep visible
                // so they can retry when browser re-fires beforeinstallprompt.
                if (choice.outcome === 'accepted') {
                    const btn = document.getElementById('btn-install');
                    if (btn) btn.style.display = 'none';
                }
                // button remains visible; it will become re-clickable once
                // beforeinstallprompt fires again (usually a few minutes later).
            });
        };

        window.addEventListener('appinstalled', () => {
            const btn = document.getElementById('btn-install');
            if (btn) btn.style.display = 'none';
        });
    </script>
    <script src="script.js"></script>
</body>

</html>
```